# burncloud-database-download é¡¹ç›®æ–‡æ¡£

## æ–‡æ¡£ç›®å½•

æœ¬é¡¹ç›®çš„æ–‡æ¡£åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š

### ğŸ“‹ [æ¶æ„æ€»è§ˆ](./architecture_overview.md)
- é¡¹ç›®æ•´ä½“æ¶æ„è®¾è®¡
- æ¨¡å—ä¾èµ–å…³ç³»
- æ•°æ®æµè½¬å›¾
- é”™è¯¯å¤„ç†ç­–ç•¥
- æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ
- æµ‹è¯•ç­–ç•¥
- éƒ¨ç½²å’Œç›‘æ§
- æ‰©å±•è§„åˆ’

### ğŸ—ƒï¸ [æ•°æ®æ¨¡å‹æµç¨‹å›¾](./models_flowcharts.md)
- `DownloadTaskRecord` è½¬æ¢å‡½æ•°æµç¨‹å›¾
- `DownloadProgressRecord` è½¬æ¢å‡½æ•°æµç¨‹å›¾
- ç±»å‹å®‰å…¨è½¬æ¢æœºåˆ¶
- é”™è¯¯å¤„ç†ç­–ç•¥
- æ—¶é—´å¤„ç†æœºåˆ¶

### ğŸ—ï¸ [æ•°æ®åº“æ¶æ„æµç¨‹å›¾](./schema_flowcharts.md)
- `initialize_schema` å‡½æ•°æµç¨‹å›¾
- æ•°æ®åº“è¡¨ç»“æ„è®¾è®¡
- è¡¨å…³ç³»å›¾
- ç´¢å¼•ç­–ç•¥
- æ•°æ®åº“çº¦æŸ
- åˆå§‹åŒ–æµç¨‹å…³é”®ç‚¹

### ğŸ“š [æ•°æ®ä»“åº“æµç¨‹å›¾](./repository_flowcharts.md)
- æ„é€ å’Œåˆå§‹åŒ–å‡½æ•°
- ä»»åŠ¡ç®¡ç†å‡½æ•°
- è¿›åº¦ç®¡ç†å‡½æ•°
- ç»Ÿè®¡å’Œç®¡ç†å‡½æ•°
- Repository æ¨¡å¼
- UPSERT æ¨¡å¼
- é”™è¯¯ä¼ æ’­é“¾
- ç±»å‹è½¬æ¢å®‰å…¨

## å¿«é€Ÿå¯¼èˆª

### æŒ‰åŠŸèƒ½æ¨¡å—æµè§ˆ
- **æ•°æ®æ¨¡å‹**: [models_flowcharts.md](./models_flowcharts.md)
- **æ•°æ®åº“æ¶æ„**: [schema_flowcharts.md](./schema_flowcharts.md)
- **æ•°æ®è®¿é—®å±‚**: [repository_flowcharts.md](./repository_flowcharts.md)

### æŒ‰å…³æ³¨ç‚¹æµè§ˆ
- **æ¶æ„è®¾è®¡**: [architecture_overview.md](./architecture_overview.md)
- **å‡½æ•°å®ç°**: å„æ¨¡å—æµç¨‹å›¾æ–‡æ¡£
- **é”™è¯¯å¤„ç†**: æ‰€æœ‰æ–‡æ¡£ä¸­çš„é”™è¯¯å¤„ç†éƒ¨åˆ†
- **æ€§èƒ½ä¼˜åŒ–**: [architecture_overview.md](./architecture_overview.md#æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)

## æ–‡æ¡£çº¦å®š

### æµç¨‹å›¾è¯´æ˜
- ğŸŸ¢ ç»¿è‰²èŠ‚ç‚¹ï¼šæˆåŠŸç»“æŸ
- ğŸ”´ çº¢è‰²èŠ‚ç‚¹ï¼šé”™è¯¯ç»“æŸ
- ğŸ”µ è“è‰²èŠ‚ç‚¹ï¼šå¼€å§‹èŠ‚ç‚¹
- ğŸŸ¡ é»„è‰²èŠ‚ç‚¹ï¼šå†³ç­–èŠ‚ç‚¹

### Mermaid å›¾è¡¨ç±»å‹
- `flowchart`: æµç¨‹å›¾
- `erDiagram`: å®ä½“å…³ç³»å›¾
- `graph`: å…³ç³»å›¾

## å¦‚ä½•ä½¿ç”¨è¿™äº›æ–‡æ¡£

1. **æ–°å›¢é˜Ÿæˆå‘˜**: ä» [æ¶æ„æ€»è§ˆ](./architecture_overview.md) å¼€å§‹äº†è§£é¡¹ç›®æ•´ä½“è®¾è®¡
2. **åŠŸèƒ½å¼€å‘**: å‚è€ƒå¯¹åº”æ¨¡å—çš„æµç¨‹å›¾æ–‡æ¡£äº†è§£å…·ä½“å®ç°
3. **é—®é¢˜æ’æŸ¥**: æŸ¥çœ‹é”™è¯¯å¤„ç†æµç¨‹å›¾å’Œç±»å‹è½¬æ¢è¯´æ˜
4. **æ€§èƒ½ä¼˜åŒ–**: å‚è€ƒæ¶æ„æ–‡æ¡£ä¸­çš„ä¼˜åŒ–ç­–ç•¥éƒ¨åˆ†

## é¡¹ç›®æ¦‚è¿°

`burncloud-database-download` æ˜¯ä¸€ä¸ªä¸“é—¨ç”¨äºä¸‹è½½ä»»åŠ¡æ•°æ®åº“æŒä¹…åŒ–çš„ Rust åº“ï¼Œè´Ÿè´£å°†ä¸‹è½½ä»»åŠ¡æ•°æ®å­˜å‚¨åˆ° SQLite æ•°æ®åº“ä¸­ã€‚è¯¥åº“æä¾›äº†å®Œæ•´çš„ä¸‹è½½ä»»åŠ¡å’Œè¿›åº¦è·Ÿè¸ªåŠŸèƒ½çš„æ•°æ®æŒä¹…åŒ–è§£å†³æ–¹æ¡ˆã€‚

### é¡¹ç›®ç»“æ„

```
src/
â”œâ”€â”€ lib.rs          # åº“å…¥å£æ–‡ä»¶ï¼Œæ¨¡å—å¯¼å‡ºå’Œä¾èµ–é‡æ–°å¯¼å‡º
â”œâ”€â”€ error.rs        # é”™è¯¯å¤„ç†å®šä¹‰ï¼ŒåŒ…å«æ‰€æœ‰é”™è¯¯ç±»å‹
â”œâ”€â”€ models.rs       # æ•°æ®æ¨¡å‹ï¼Œæ•°æ®åº“è®°å½•ä¸ä¸šåŠ¡å¯¹è±¡çš„è½¬æ¢
â”œâ”€â”€ repository.rs   # æ•°æ®ä»“åº“ï¼Œæ ¸å¿ƒCRUDæ“ä½œå®ç°
â””â”€â”€ schema.rs       # æ•°æ®åº“æ¨¡å¼ï¼Œè¡¨ç»“æ„å’Œç´¢å¼•å®šä¹‰

tests/
â”œâ”€â”€ schema_tests.rs    # æ•°æ®åº“æ¶æ„æµ‹è¯•
â”œâ”€â”€ models_tests.rs    # æ•°æ®æ¨¡å‹æµ‹è¯•
â””â”€â”€ repository_tests.rs # æ•°æ®ä»“åº“æµ‹è¯•

docs/
â”œâ”€â”€ README.md                    # æœ¬æ–‡æ¡£ï¼Œé¡¹ç›®å’Œæ–‡æ¡£æ€»è§ˆ
â”œâ”€â”€ architecture_overview.md     # é¡¹ç›®æ¶æ„æ€»è§ˆ
â”œâ”€â”€ models_flowcharts.md        # æ•°æ®æ¨¡å‹æµç¨‹å›¾
â”œâ”€â”€ schema_flowcharts.md        # æ•°æ®åº“æ¶æ„æµç¨‹å›¾
â””â”€â”€ repository_flowcharts.md    # æ•°æ®ä»“åº“æµç¨‹å›¾
```

## ä¸»è¦åŠŸèƒ½ç‰¹æ€§

### ä¸‹è½½ä»»åŠ¡ç®¡ç†
- âœ… ä»»åŠ¡åˆ›å»ºå’Œä¿å­˜
- âœ… é‡å¤é“¾æ¥æ£€æµ‹ï¼š`DownloadTask::new` å‡½æ•°åœ¨ç¢°åˆ°é‡å¤çš„ä¸‹è½½é“¾æ¥æ—¶ï¼Œä¼šç›´æ¥è¿”å›å·²å­˜åœ¨çš„ task-id
- âœ… ä»»åŠ¡çŠ¶æ€è·Ÿè¸ª
- âœ… ä»»åŠ¡æŸ¥è¯¢å’Œåˆ—è¡¨
- âœ… æŒ‰çŠ¶æ€ç­›é€‰ä»»åŠ¡
- âœ… ä»»åŠ¡åˆ é™¤æ“ä½œ

### ä¸‹è½½è¿›åº¦è·Ÿè¸ª
- âœ… å®æ—¶è¿›åº¦ä¿å­˜
- âœ… ä¸‹è½½é€Ÿåº¦è®°å½•
- âœ… é¢„è®¡å‰©ä½™æ—¶é—´
- âœ… è¿›åº¦å†å²æŸ¥è¯¢

### æ•°æ®æŒä¹…åŒ–
- âœ… SQLite æ•°æ®åº“æ”¯æŒ
- âœ… äº‹åŠ¡å®‰å…¨æ“ä½œ
- âœ… å¤–é”®çº¦æŸä¿è¯æ•°æ®ä¸€è‡´æ€§
- âœ… æ€§èƒ½ä¼˜åŒ–ç´¢å¼•

### é”™è¯¯å¤„ç†
- âœ… ç»“æ„åŒ–é”™è¯¯ç±»å‹
- âœ… è‡ªåŠ¨é”™è¯¯è½¬æ¢
- âœ… è¯¦ç»†é”™è¯¯ä¿¡æ¯
- âœ… ä¼˜é›…çš„é”™è¯¯ä¼ æ’­

## é‡å¤é“¾æ¥å¤„ç†æœºåˆ¶

### DownloadTask::new é‡å¤æ£€æµ‹

`DownloadTask::new` å‡½æ•°å®ç°äº†æ™ºèƒ½çš„é‡å¤é“¾æ¥æ£€æµ‹æœºåˆ¶ï¼š

1. **é‡å¤æ£€æµ‹é€»è¾‘**: åœ¨åˆ›å»ºæ–°ä»»åŠ¡æ—¶ï¼Œä¼šæ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„ä¸‹è½½é“¾æ¥
2. **è¿”å›è¡Œä¸º**:
   - å¦‚æœæ˜¯æ–°é“¾æ¥ï¼šåˆ›å»ºæ–°çš„ä»»åŠ¡ï¼Œè¿”å›æ–°çš„ task-id
   - å¦‚æœæ˜¯é‡å¤é“¾æ¥ï¼šç›´æ¥è¿”å›å·²å­˜åœ¨ä»»åŠ¡çš„ task-idï¼Œä¸åˆ›å»ºé‡å¤ä»»åŠ¡
3. **æ¯”è¾ƒæ ‡å‡†**: åŸºäºå®Œæ•´çš„ä¸‹è½½ URL è¿›è¡ŒåŒ¹é…
4. **æ€§èƒ½ä¼˜åŒ–**: ä½¿ç”¨æ•°æ®åº“ç´¢å¼•ç¡®ä¿å¿«é€Ÿçš„é‡å¤æ£€æµ‹

### ä½¿ç”¨ç¤ºä¾‹

```rust
// ç¬¬ä¸€æ¬¡è°ƒç”¨ - åˆ›å»ºæ–°ä»»åŠ¡
let task1 = DownloadTask::new(
    "https://example.com/file.zip".to_string(),
    PathBuf::from("/downloads/file.zip")
);
println!("Task ID: {}", task1.id); // è¾“å‡º: æ–°çš„ UUID

// ç¬¬äºŒæ¬¡è°ƒç”¨ç›¸åŒ URL - è¿”å›å·²å­˜åœ¨çš„ä»»åŠ¡
let task2 = DownloadTask::new(
    "https://example.com/file.zip".to_string(),  // ç›¸åŒçš„ URL
    PathBuf::from("/downloads/another_path.zip") // ä¸åŒçš„è·¯å¾„ä¹Ÿä¼šè¿”å›ç›¸åŒä»»åŠ¡
);
println!("Task ID: {}", task2.id); // è¾“å‡º: ä¸ task1.id ç›¸åŒçš„ UUID
```

## å¿«é€Ÿå¼€å§‹

### 1. æ·»åŠ ä¾èµ–

```toml
[dependencies]
burncloud-database-download = { path = "path/to/burncloud-database-download" }
burncloud-database = { path = "path/to/burncloud-database" }
burncloud-download-types = { path = "path/to/burncloud-download-types" }
tokio = { version = "1.0", features = ["full"] }
```

### 2. åŸºæœ¬ä½¿ç”¨

```rust
use burncloud_database_download::{
    DownloadRepository,
    Database,
    DownloadTask,
    DownloadProgress,
    Result
};
use std::path::PathBuf;

#[tokio::main]
async fn main() -> Result<()> {
    // åˆ›å»ºæ•°æ®åº“è¿æ¥
    let db = Database::new("downloads.db").await?;

    // åˆ›å»ºä»“åº“å®ä¾‹
    let repo = DownloadRepository::new(db);

    // åˆå§‹åŒ–æ•°æ®åº“æ¨¡å¼
    repo.initialize().await?;

    // åˆ›å»ºä¸‹è½½ä»»åŠ¡
    // æ³¨æ„ï¼šDownloadTask::new åœ¨ç¢°åˆ°é‡å¤çš„ä¸‹è½½é“¾æ¥æ—¶ï¼Œä¼šç›´æ¥è¿”å›å·²å­˜åœ¨çš„ task-id
    let task = DownloadTask::new(
        "https://example.com/file.zip".to_string(),
        PathBuf::from("/downloads/file.zip")
    );

    // ä¿å­˜ä»»åŠ¡
    repo.save_task(&task).await?;

    // æ›´æ–°è¿›åº¦
    let progress = DownloadProgress {
        downloaded_bytes: 1024,
        total_bytes: Some(10240),
        speed_bps: 512,
        eta_seconds: Some(18),
    };
    repo.save_progress(&task.id, &progress).await?;

    // æŸ¥è¯¢ä»»åŠ¡
    let retrieved_task = repo.get_task(&task.id).await?;
    println!("ä»»åŠ¡URL: {}", retrieved_task.url);

    // è·å–æ‰€æœ‰ä»»åŠ¡
    let all_tasks = repo.list_tasks().await?;
    println!("æ€»ä»»åŠ¡æ•°: {}", all_tasks.len());

    Ok(())
}
```

### 3. é”™è¯¯å¤„ç†

```rust
use burncloud_database_download::{DownloadDbError, Result};

async fn handle_errors() -> Result<()> {
    match repo.get_task(&task_id).await {
        Ok(task) => {
            println!("æ‰¾åˆ°ä»»åŠ¡: {}", task.url);
        }
        Err(DownloadDbError::TaskNotFound(id)) => {
            println!("ä»»åŠ¡æœªæ‰¾åˆ°: {}", id);
        }
        Err(DownloadDbError::Database(db_err)) => {
            println!("æ•°æ®åº“é”™è¯¯: {}", db_err);
        }
        Err(e) => {
            println!("å…¶ä»–é”™è¯¯: {}", e);
        }
    }
    Ok(())
}
```

## æ•°æ®åº“è®¾è®¡

### è¡¨ç»“æ„

#### download_tasks è¡¨
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | TEXT | ä»»åŠ¡UUID (ä¸»é”®) |
| url | TEXT | ä¸‹è½½URL |
| target_path | TEXT | ç›®æ ‡è·¯å¾„ |
| status | TEXT | çŠ¶æ€JSON |
| created_at | INTEGER | åˆ›å»ºæ—¶é—´æˆ³ |
| updated_at | INTEGER | æ›´æ–°æ—¶é—´æˆ³ |

#### download_progress è¡¨
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| task_id | TEXT | ä»»åŠ¡ID (ä¸»é”®/å¤–é”®) |
| downloaded_bytes | INTEGER | å·²ä¸‹è½½å­—èŠ‚ |
| total_bytes | INTEGER | æ€»å­—èŠ‚æ•° (å¯é€‰) |
| speed_bps | INTEGER | ä¸‹è½½é€Ÿåº¦ |
| eta_seconds | INTEGER | å‰©ä½™æ—¶é—´ (å¯é€‰) |
| updated_at | INTEGER | æ›´æ–°æ—¶é—´æˆ³ |

### æ€§èƒ½ä¼˜åŒ–

- âœ… çŠ¶æ€å­—æ®µç´¢å¼• - ä¼˜åŒ–çŠ¶æ€ç­›é€‰
- âœ… åˆ›å»ºæ—¶é—´ç´¢å¼• - ä¼˜åŒ–æ—¶é—´æ’åº
- âœ… æ›´æ–°æ—¶é—´ç´¢å¼• - æ”¯æŒæ—¶é—´æŸ¥è¯¢
- âœ… å¤–é”®çº¦æŸ - ä¿è¯æ•°æ®ä¸€è‡´æ€§

## æµ‹è¯•è¦†ç›–

æ¯ä¸ªæ¨¡å—éƒ½åŒ…å«å…¨é¢çš„å•å…ƒæµ‹è¯•ï¼š

- âœ… **models.rs**: æ•°æ®è½¬æ¢å¾€è¿”æµ‹è¯•
- âœ… **repository.rs**: CRUDæ“ä½œåŠŸèƒ½æµ‹è¯•
- âœ… **schema.rs**: æ•°æ®åº“åˆå§‹åŒ–æµ‹è¯•
- âœ… **error.rs**: é”™è¯¯å¤„ç†éªŒè¯

è¿è¡Œæµ‹è¯•ï¼š
```bash
cargo test
```

## æ€§èƒ½ç‰¹æ€§

### æŸ¥è¯¢ä¼˜åŒ–
- ä½¿ç”¨ç´¢å¼•åŠ é€Ÿå¸¸ç”¨æŸ¥è¯¢
- æ‰¹é‡æ“ä½œå‡å°‘æ•°æ®åº“å¾€è¿”
- è¿æ¥æ± å¤ç”¨æ•°æ®åº“è¿æ¥

### å†…å­˜æ•ˆç‡
- æµå¼å¤„ç†å¤§é‡æ•°æ®
- æœ€å°åŒ–å†…å­˜åˆ†é…
- é«˜æ•ˆçš„åºåˆ—åŒ–/ååºåˆ—åŒ–

### å¹¶å‘å®‰å…¨
- æ‰€æœ‰æ“ä½œéƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„
- æ”¯æŒå¤šä¸ªå¹¶å‘è¿æ¥
- äº‹åŠ¡ä¿è¯æ•°æ®ä¸€è‡´æ€§

## æœ€ä½³å®è·µ

### 1. é”™è¯¯å¤„ç†
```rust
// ä½¿ç”¨ ? æ“ä½œç¬¦è¿›è¡Œé”™è¯¯ä¼ æ’­
async fn download_workflow() -> Result<()> {
    let repo = setup_repository()?;
    repo.initialize().await?;
    // ... å…¶ä»–æ“ä½œ
    Ok(())
}
```

### 2. èµ„æºç®¡ç†
```rust
// ç¡®ä¿æ­£ç¡®åˆå§‹åŒ–
let repo = DownloadRepository::new(database);
repo.initialize().await?; // å¿…é¡»è°ƒç”¨
```

### 3. æ‰¹é‡æ“ä½œ
```rust
// æ‰¹é‡æŸ¥è¯¢æ¯”å¾ªç¯å•ä¸ªæŸ¥è¯¢æ›´é«˜æ•ˆ
let all_tasks = repo.list_tasks().await?;
let running_tasks = repo.list_tasks_by_status(&DownloadStatus::Running).await?;
```

## æ‰©å±•æŒ‡å—

### æ·»åŠ æ–°å­—æ®µ
1. ä¿®æ”¹ schema.rs ä¸­çš„è¡¨å®šä¹‰
2. æ›´æ–° models.rs ä¸­çš„ç»“æ„ä½“
3. è°ƒæ•´è½¬æ¢æ–¹æ³•
4. æ·»åŠ ç›¸åº”æµ‹è¯•

### è‡ªå®šä¹‰æŸ¥è¯¢
1. åœ¨ repository.rs ä¸­æ·»åŠ æ–°æ–¹æ³•
2. å®ç°ç›¸åº”çš„ SQL æŸ¥è¯¢
3. å¤„ç†é”™è¯¯æƒ…å†µ
4. ç¼–å†™æµ‹è¯•ç”¨ä¾‹

### æ€§èƒ½ä¼˜åŒ–
1. åˆ†ææŸ¥è¯¢æ¨¡å¼
2. æ·»åŠ ç›¸åº”ç´¢å¼•
3. ä¼˜åŒ– SQL è¯­å¥
4. ç›‘æ§æ€§èƒ½æŒ‡æ ‡

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥**
   - æ£€æŸ¥æ–‡ä»¶æƒé™
   - ç¡®ä¿è·¯å¾„å­˜åœ¨
   - éªŒè¯ SQLite ç‰ˆæœ¬

2. **ä»»åŠ¡ä¿å­˜å¤±è´¥**
   - æ£€æŸ¥æ•°æ®æ ¼å¼
   - éªŒè¯å¿…å¡«å­—æ®µ
   - æŸ¥çœ‹é”™è¯¯è¯¦æƒ…

3. **æŸ¥è¯¢æ€§èƒ½é—®é¢˜**
   - æ£€æŸ¥ç´¢å¼•ä½¿ç”¨
   - åˆ†ææŸ¥è¯¢è®¡åˆ’
   - è€ƒè™‘æ•°æ®é‡å¤§å°

### è°ƒè¯•æŠ€å·§

```rust
// å¯ç”¨è¯¦ç»†æ—¥å¿—
env_logger::init();

// æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
let count = repo.count_tasks().await?;
println!("å½“å‰ä»»åŠ¡æ•°: {}", count);

// éªŒè¯æ•°æ®å®Œæ•´æ€§
let stats = repo.count_tasks_by_status().await?;
for (status, count) in stats {
    println!("çŠ¶æ€ {}: {} ä¸ªä»»åŠ¡", status, count);
}
```

## ç‰ˆæœ¬å†å²

- **v0.1.0**: åˆå§‹ç‰ˆæœ¬ï¼ŒåŸºæœ¬åŠŸèƒ½å®ç°

## è´¡çŒ®æŒ‡å—

1. Fork é¡¹ç›®
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
3. ç¼–å†™æµ‹è¯•
4. æäº¤å˜æ›´
5. åˆ›å»º Pull Request

## è®¸å¯è¯

æœ¬é¡¹ç›®ä½¿ç”¨ MIT è®¸å¯è¯ã€‚

---

**æ³¨æ„**: è¿™æ˜¯ä¸€ä¸ªå†…éƒ¨åº“æ–‡æ¡£ï¼Œä¸“ä¸º burncloud é¡¹ç›®è®¾è®¡ã€‚å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿã€‚